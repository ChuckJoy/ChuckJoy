<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<title>Video Therimen  - using DiffCamEngine </title>
  
		<style>
		 
			body {
				margin: 20px;
				font: 1.5em/1.2 sans-serif;
				text-align: center;
			}
			
			figure {
				display: inline-block;
				margin: 10px;
				vertical-align: top;
			}
			
			figcaption {
				text-align: left;
				font-weight: bold;
			}
			
			metric {
				display: inline-block;
				margin: 10px;
				vertical-align: top;
			}
			
			metriccaption {
				text-align: left;
				font-weight: bold;
			}
			video  {
			   width: 640px;
				height: 360px;
				background-color: #999;
			}
            canvas {
				width: 640px;
				height: 360px;
				background-color: #999;
			}
			
			canvas {
				image-rendering: pixelated;
			}
            .button1 {background-color: #f01d09;} /* Blue */
            .button2 {background-color: #f01d09;} /* Blue */
            .button3 {background-color: #f01d09;} /* Blue */
            .button4 {background-color: #0a0dd1;} /* Blue */
            .button5 {background-color: #2200ff;} /* Blue */
            .button6 {background-color: #921717;} /* Blue */
            .button7 {background-color: #ce403b;} /* Blue */
            .button8 {background-color: #f01d09;} /* Red */
            
            .button {
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            }
			</style>
			
	</head>
	<body>
		<figure>
			<video id="video"></video>
			<figcaption>Live Video</figcaption>
		</figure><br>

		<figure>
			<canvas id="motion"></canvas>
			<figcaption>
				MIDI Out:   <span id="metric0"> ?," "</span><span id="metricm2"> ?</span><span id="metricm3">?</span><br>
				
			</figcaption>
		</figure>
        <div> 
        <!--    Motion2: <span id="metric1">?</span><br> 
            Motion3: <span id="metric2">?</span><br> 
            Motion4: <span id="metric3">?</span> <br>
            Motion5: <span id="metric4">?</span> <br> -->
            <button onclick="playKey()"; class="button4" >Play MIDI notes in Key</button>
          
        </div>
       <script type="importmap">
			{
				"imports": {
					"three": "./build/three.module.js",
					"three/addons/": "./jsm/"
				}
			}
	</script>
    	
		<script src="https://webrtc.github.io/adapter/adapter-1.0.7.js"></script>
		<script src="./diff-cam-engine.js"></script>
	
		<script type="text/javascript" src="./dat.gui.min.js"></script>  
     	
<script type="module" >
import * as THREE from 'three';
		
//***********************************************************************************************************
//***********************************************************************************************************
//***********************************************************************************************************
var video = document.getElementById('video');
var canvas = document.getElementById('motion');
var metric0 = document.getElementById('metric0');
var metricm2 = document.getElementById('metricm2');
var metricm3 = document.getElementById('metricm3');
////var metric1 = document.getElementById('metric1');
//var metric2 = document.getElementById('metric2');
//var metric3 = document.getElementById('metric3');
//var metric4 = document.getElementById('metric4');
let FrameCounter = 0;
let testosc ;

const listener = new THREE.AudioListener();
			 
const sound3 = new THREE.PositionalAudio( listener );
const oscillator = listener.context.createOscillator();
oscillator.type = 'sine';
oscillator.frequency.setValueAtTime( 144, sound3.context.currentTime );
//oscillator.start( 0 );
sound3.setNodeSource( oscillator );
sound3.setRefDistance( 20 );
sound3.setVolume( 0.5 );
			 



// 10 parms, 12 trig call enables plus 12 zone call enables  
var threshold = {
	Vthresh:40, 	// vertical
	Hthres:80,		// horizontal
	Xloleft:40,
	Xhiright:215,
	XXsmall:25,
	XXlarge:120,
	Ylotop:35,
	Yhibot:110,
	YYsmall:25,
	YYlarge:75,
	still: 25,  // 2 sec
	mkey: 0,  // key = c
	trig_smx_EN: true,
	trig_smy_EN: true,
	trig_smxy_EN: true,
	trig_vert_EN: true,
	trig_hor_EN: true,
	trig_square_EN: true,
	trig_lo_EN: true,
	trig_hi_EN: true,
	trig_left_EN: true,
	trig_right_EN: true,
	trig_centerX_EN: true,
	trig_tallY_EN: true,
	trig_wideX_EN: true,
	trig_still_EN: true,
	trig_still10_EN: true,

	zone1_EN: true,
	zone2_EN: true,
	zone3_EN: true,
	zone4_EN: true,
	zone5_EN: true,
	zone6_EN: true,
	zone7_EN: true,
	zone8_EN: true,
	zone9_EN: true,
	zone10_EN: true,
	zone11_EN: true,
	zone12_EN: true

	};

let wid = 256;
let hei = 144;
let i;
let payload;
//***********************************************************************************************************

function initSuccess() {
	DiffCamEngine.start();
}

function initError() {
	alert('Something went wrong.');
}


function capture(pload) {
	payload=pload;
	FrameCounter++;
	if(threshold.trig_still_EN&&FrameCounter>threshold.still)  {trig_still(); FrameCounter = 0; }
	if(threshold.trig_still10_EN&&FrameCounter==10) {trig_still10();}
	if(threshold.trig_still20_EN&&FrameCounter==20) {trig_still10();}

/*	metric1.textContent = '0';
	metric2.textContent = '0';
	metric3.textContent = '0';
	metric4.textContent = '0';
	//console.log('payload:',pload );
*/
	if(pload.hasMotion&&pload.motionPixels) {
		metric2.textContent = pload.motionPixels;//&pload.motionBox;
		console.log('Motion Pixels:',pload.motionPixels );	
		}
	//console.log('capture',pload.score,pload.hasMotion,pload.motionBox,pload.motionPixels );
	
	if(pload.hasMotion&&pload.motionBox) {
		motionParse( ) ;
		}
	}  // !capture


function motionParse( ) {
	let x1=(payload.motionBox.x.min) ;
	let y1=(payload.motionBox.y.min) ;
	let x2=(payload.motionBox.x.max) ;
	let y2=(payload.motionBox.y.max) ;
	let xx = x2-x1;
	let yy = y2-y1;	
	console.log('motion:',payload.score,x1,y1,x2,y2,"DIF:",xx,yy,FrameCounter);
	// threshold.Hthres   threshold.Vthres
    
	if(xx/yy >= 2 && threshold.trig_hor_EN) {FrameCounter = 0; Trig_Motion_Out(0,'trig_hor');}    // :80, horizontal
	else if( yy/xx >= 2 && threshold.trig_vert_EN) {FrameCounter = 0;  Trig_Motion_Out(1,'trig_vert');}	// 40,  vertical
	else if( threshold.trig_square_EN)  {FrameCounter = 0;  Trig_Motion_Out(2,'trig_square'); }	// 70,  square
	
	if( x1 < threshold.Xloleft&& threshold.trig_left_EN)    {FrameCounter = 0; Trig_Motion_Out(3,'trig_left');  }		// :40,
	else if( x2 > threshold.Xhiright&& threshold.trig_right_EN)   {FrameCounter = 0; Trig_Motion_Out(4,'trig_right');}  // :215,
	else if( threshold.trig_centerX_EN) {FrameCounter = 0; Trig_Motion_Out(5,'trig_centerX');} 
	
    if( xx < threshold.XXsmall&& threshold.trig_smx_EN)    {FrameCounter = 0; Trig_Motion_Out(6,'trig small x');   } // :25,
	else if( xx > threshold.XXlarge&& threshold.trig_wideX_EN) {FrameCounter = 0; Trig_Motion_Out(7,'trig large x'); } // :120,
	else if( threshold.trig_smx_EN||threshold.trig_wideX_EN)   {FrameCounter = 0; Trig_Motion_Out(8,'trig_medx');}  // :25,25
	//&& threshold.trig_smxy_EN
    if( y1 < threshold.Ylotop&& threshold.trig_lo_EN)      {FrameCounter = 0; Trig_Motion_Out(9,'trig lo y');  }  // :35,
	else if( y2 > threshold.Yhibot&& threshold.trig_hi_EN)      {FrameCounter = 0; Trig_Motion_Out(10,'trig hi y');	} // :110,
	else if( threshold.trig_hi_EN)      {FrameCounter = 0; Trig_Motion_Out(11,'trig med y');	} // :110,
	
    if( yy < threshold.YYsmall&& threshold.trig_smy_EN)    {FrameCounter = 0; Trig_Motion_Out(12,'trig short y'); }  // :25,
	else if( yy > threshold.YYlarge&& threshold.trig_tallY_EN)  {FrameCounter = 0; Trig_Motion_Out(13,'trig tall y'); }  // :75,
	else if( threshold.trig_tallY_EN)  {FrameCounter = 0; Trig_Motion_Out(14,'trig med y'); }  // :75,
	
     x1=xx/2;
     y1=yy/2;
	if((x1<1*256/4) && (y1<1*144/3) && threshold.zone1_EN)      { Trig_zone_Out(0);  } // Z11
	else if((x1<2*256/4) && (y1<1*144/3) && threshold.zone2_EN) { Trig_zone_Out(1); } // Z21
	else if((x1<3*256/4) && (y1<1*144/3) && threshold.zone3_EN) { Trig_zone_Out(2); } // Z31
	else if((x1<4*256/4) && (y1<1*144/3) && threshold.zone4_EN) { Trig_zone_Out(3); } // Z41

	else if((x1<1*256/4) && (y1<2*144/3) && threshold.zone5_EN) { Trig_zone_Out(4);} // Z12
	else if((x1<2*256/4) && (y1<2*144/3) && threshold.zone6_EN) { Trig_zone_Out(5); } // Z22
	else if((x1<3*256/4) && (y1<2*144/3) && threshold.zone7_EN) { Trig_zone_Out(6); } // Z32
	else if((x1<4*256/4) && (y1<2*144/3) && threshold.zone8_EN) { Trig_zone_Out(7); } // Z42
	
	else if((x1<1*256/4) && (y1<3*144/3) && threshold.zone9_EN) { Trig_zone_Out(8); } // Z13
	else if((x1<2*256/4) && (y1<3*144/3) && threshold.zonea_EN) { Trig_zone_Out(9); } // Z23
	else if((x1<3*256/4) && (y1<3*144/3) && threshold.zoneb_EN) { Trig_zone_Out(10); } // Z33
	else if((x1<4*256/4) && (y1<3*144/3) && threshold.zonec_EN) { Trig_zone_Out(11); } // Z43
			
	}

 
function trig_still()  {
	console.log('trig still', FrameCounter);
    midiANO() ;   // all notes off
  	FrameCounter = 0;
}

function trig_still10()  {
	console.log('trig still10',FrameCounter);
    midiANO() ;    // all notes off
    }
 
	  
function midiANO(){        
    for(i=0;i<16;i++)	{
	midiSend(0xB0+i,123,0,0);  //ALL Notes off - every channel.  7F=127  7b=123 128-16= 112-127==70-7F   FE=active sense code
	}
  }

/////if(typeof config.textureBank != 'undefined') 
function Trig_Motion_Out(index,name) {
  console.log('trig Motion:', index,name);
			
  if(typeof payload.motionBox != 'undefined') {	
	let x1=(payload.motionBox.x.min) ;
	let y1=(payload.motionBox.y.min) ;
	let x2=(payload.motionBox.x.max) ;
	let y2=(payload.motionBox.y.max) ;
	let xx = x2-x1;
	let yy = y2-y1;	
	let nn = y2/2-50;
	if (nn>127) nn = 61; 
	let dur = (x1+x2+y1+y2);
	let dur2 = payload.score*4 ;
    let note = threshold.mkey + index*2;
	//metric1.textContent = dur;
	//metric2.textContent = dur2;
	
	if(index==0 || index==1 || index==2 )  {  //hor vert square
		midiSend(NOTE_ON+1, note+xx, yy,dur2);
	}
	if(index==3 || index==4 || index==5 )  {   // left right center x
		midiSend(NOTE_ON+2, note+yy,nn, dur);
	}
	if(index==6 || index==7 || index==8 )  {   // small med large x
		midiSend(NOTE_ON+3, note+xx,nn, dur);
	}
    if(index==9 || index==10 || index==11 )  {   // lo hi  med y
		midiSend(NOTE_ON+4, note+yy,nn, dur);
	}
    if(index==12 || index==13 || index==14 )  {   //short tAll med y
		midiSend(NOTE_ON+index-8, note+xx,nn, dur);
	}
	 
  }
}	 // !trig motion out
 
function Trig_zone_Out(index) {
    console.log('trig zone:', index);
	if(typeof payload.motionBox != 'undefined') {	
	let x1=(payload.motionBox.x.min) ;
	let y1=(payload.motionBox.y.min) ;
	let x2=(payload.motionBox.x.max) ;
	let y2=(payload.motionBox.y.max) ;
	let xx = x2-x1;
	let ax = (x2+x1)/2;
	let ay = (y2-y1)/2;
	let yy = y2-y1;	
	let nn = y2/2-50;
	if (nn>127) nn = 61; 
	let dur = (x1+x2+y1+y2);
	let dur2 = payload.score*4 ;
    let p1 = (ax/2);  
    if (p1>120) p1=(12+threshold.mkey)*3+index;
    let p2 = ay;  
    if (p2>120) p2=(12+threshold.mkey)*2+index;
   // metric3.textContent = p1;
	//metric4.textContent = p2;

	if(index>=0 && index<=11) {  // zone 1-12
		midiSend(NOTE_ON , p1, xx+yy,dur2);
	}
    if(index==0 || index==1 || index==2 || index==3)  {
	 	midiSend(NOTE_ON+4, p2, yy,dur2);
	}
	if(index==4 || index==5 || index==6 || index==7)  {
	    midiSend(NOTE_ON+4,  p1,nn, dur);
	}
	if(index==8 || index==9 || index==10 || index==11)  {
	  	midiSend(NOTE_ON+4,  p2,nn, dur2);
	}
  }
}	 // !trig zone out
 



function menuTestOscWave(selection)  {	
		console.log('menu-selection:' ,selection);
		// Sine: sine, Square: square, Triange: triangle, Sawtooth: sawtooth
		console.log(testosc.context.state);
		
		if (selection == 'off') 
			{
			if (testosc.context.state == "running") { 
				testosc.stop(0);
			}
		}	//  /if
		else  {
			testosc.type = selection;
		//	if (testosc.context.state != "running") { 
				testosc.start(0);
		//		}
			} //  else	
		
	}  //   /menuTestOscWave()FrequencyData
	
	
	function menuTestFreq()  {
		testosc.frequency.value = config.TestOscFreq;
		testosc.setVolume=(config.TestOscVol/100);
	 	console.log('TestOscFreq % Vol: ',  testosc ); 
	
		}	


//***********************************************************************************************************


let config = {
	video: video,
	motionCanvas: canvas,
	initSuccessCallback: initSuccess,
	initErrorCallback: initError,
	captureCallback: capture,
	captureIntervalTime: 100,		
	pixelDiffThreshold: 32,
	scoreThreshold: 16,
	captureWidth: 1280,
	captureHeight: 720,
	diffWidth: 256,				//256x144  downscaled width for diff/motion
	diffHeight: 144,				// downscaled height for diff/motion
	includeMotionBox: true,		// flag to calculate and draw motion bounding box
	includeMotionPixels: false,	// flag to create object denoting pixels with motion
    
    TestOscWaveform:'off', //{'OFF':'off', 'Sine':'sine', 'Square':'square', 'Triange':'triangle', 'Sawtooth':'sawtooth'} ).onChange(menuTestOscWave);
	TestOscFreq:432,
	TestOscVol: 75,
			
} ;

let config1 = {
	pixelDiffThreshold: 32,
	scoreThreshold: 1,
	captureWidth: 1280,
	captureHeight: 720,
	captureDivisor:8,
	diffWidth: 256,				// downscaled width for diff/motion
	diffHeight: 144,				// downscaled height for diff/motion
	includeMotionBox: true,		// flag to calculate and draw motion bounding box
	includeMotionPixels: false	// flag to create object denoting pixels with motion
} ;

//***********************************************************************************************************
const delay = ms => new Promise(res => setTimeout(res, ms));
 
  
   
function playKey() {
    let n;
    let i=0;
    let octbase = 2; 
    let oct = 2;
    let ol = 12*octbase+threshold.mkey;
    let oll =  oct*12;
    for(i = 1;i<oll;i++) {
        n = MIDIkeys(threshold.mkey,i+ol);
        i=n-ol;
      //  console.log("playKey Notes:", threshold.mkey,i,n);
        midiSend(NOTE_ON,n,84,500);
        delay(800);   
        
        }
    }  // !playKey
 



							    // 00 01 02 03 04 05 06 07 08 09 10 11    12    
							    // 12 13 14 15 16 17 18 19 20 21 22 23    24 
function MIDIkeys(key,note) {  	// c  c# d  d# e  f  f# g  g# a  a#  b    c+
  if(note>120) { console.log('note:',note); return note; }	// 24 25 26 27 28 29 30 31 32 33 34 35    36
  for(let o=12;o<120;o=o+12)  {
	for(let i=0;i<12;i++) {  
		if(i==1||i==3||i==6||i==8||i==10) i++;
       //  console.log('scale:',(key+i+o),note);
		if((key+i+o)==note) {  console.log('mknote1:',note); return note; } // if note in key, return
		}  // !for i
	}	// !for o	
    note++;
    console.log('mknote:',note);
	return note;  // note not in key, add 1 to make in key	
	}
 

function init() {
	
	config.captureWidth = config1.captureWidth;
	config1.captureHeight = config1.captureWidth*9/16;
	config.captureHeight = config1.captureWidth*9/16;
	config.captureDivisor = config1.captureWidth/config1.diffWidth;
	config.diffWidth = config1.diffWidth;
	config1.diffHeight = config1.diffWidth*9/16;
	config.diffHeight = config1.diffWidth*9/16;
	  
	video.width = config.captureWidth ; 
	video.height = config.captureHeight;
	canvas.width = config.captureWidth ; 
	canvas.height = config.captureHeight;
	gui.updateDisplay();

	DiffCamEngine.init(config);
	}  //  !init

//***********************************************************************************************************

let gui = new dat.GUI({ width: 320 , background_color: 0xFFFFFF });
SetupGUI() ;
init();

//***********************************************************************************************************

function SetupGUI() {		
	gui.close();
	gui = new dat.GUI({ width: 320 , background_color: 0xFFFFFF });
     
	let GUILABEL = gui.addFolder('Motion Controls');
	gui.add( config, 'includeMotionBox').name('include Motion Box').onChange(init);
	gui.add( config, 'includeMotionPixels').name('include Motion Pixels').onChange(init);
	gui.add( config, 'pixelDiffThreshold', 1, 200 ).name('pixel threshold').onChange(init);
	gui.add( config, 'scoreThreshold', 1, 200 ).name('score threshold').onChange(init);
    gui.add( threshold, 'mkey', 0, 11 ).step(1).name('MIDI Key (0=c 11=b)').onChange(playKey);

	let tgui = gui.addFolder('trigger callback enables');
	let zgui = gui.addFolder('zone trigger callback enables');

	gui.add( config, 'captureIntervalTime', 1, 200 ).name('Capture Interval mS').onChange(init);
	gui.add( config1, 'captureWidth', 320, 1920 ).step(80).name('Capture width').onChange(init);
	gui.add( config1, 'captureHeight', 0,0 ).name('Capture height').onChange(init);
	gui.add( config1, 'diffWidth', 32, 640 ).step(16).name('Differencing width').onChange(init);
	gui.add( config1, 'diffHeight', 0,0 ).name('Differencing height').onChange(init);
	 
	tgui.add( threshold, 'trig_smx_EN').name('trig_smx_EN').onChange(init);
	tgui.add( threshold, 'trig_smy_EN').name('trig_smy_EN').onChange(init);
	tgui.add( threshold, 'trig_smxy_EN').name('trig_smxy_EN').onChange(init);
	tgui.add( threshold, 'trig_vert_EN').name('trig_vert_EN').onChange(init);
	tgui.add( threshold, 'trig_hor_EN').name('trig_hor_EN').onChange(init);
	tgui.add( threshold, 'trig_square_EN').name('trig_square_EN').onChange(init);
	tgui.add( threshold, 'trig_lo_EN').name('trig_lo_EN').onChange(init);
	tgui.add( threshold, 'trig_hi_EN').name('trig_hi_EN').onChange(init);
	tgui.add( threshold, 'trig_left_EN').name('trig_left_EN').onChange(init);
	tgui.add( threshold, 'trig_right_EN').name('trig_right_EN').onChange(init);
	tgui.add( threshold, 'trig_centerX_EN').name('trig_centerX_EN').onChange(init);
	tgui.add( threshold, 'trig_tallY_EN').name('trig_tallY_EN').onChange(init);
	tgui.add( threshold, 'trig_wideX_EN').name('trig_wideX_EN').onChange(init);
	tgui.add( threshold, 'trig_still_EN').name('trig_still_EN').onChange(init);
	tgui.add( threshold, 'trig_still10_EN').name('trig_still10_EN').onChange(init);
	
	zgui.add( threshold, 'zone1_EN').name('zone1_EN').onChange(init);
	zgui.add( threshold, 'zone2_EN').name('zone2_EN').onChange(init);
	zgui.add( threshold, 'zone3_EN').name('zone3_EN').onChange(init);
	zgui.add( threshold, 'zone4_EN').name('zone4_EN').onChange(init);
	zgui.add( threshold, 'zone5_EN').name('zone5_EN').onChange(init);
	zgui.add( threshold, 'zone6_EN').name('zone6_EN').onChange(init);
	zgui.add( threshold, 'zone7_EN').name('zone7_EN').onChange(init);
	zgui.add( threshold, 'zone8_EN').name('zone8_EN').onChange(init);
	zgui.add( threshold, 'zone9_EN').name('zone9_EN').onChange(init);
	zgui.add( threshold, 'zone10_EN').name('zone10_EN').onChange(init);
	zgui.add( threshold, 'zone11_EN').name('zone11_EN').onChange(init);
	zgui.add( threshold, 'zone12_EN').name('zone12_EN').onChange(init);
	
    let TestOscFolder = gui.addFolder('Test Oscillator');
	TestOscFolder.add( config, 'TestOscWaveform', {'OFF':'off', 'Sine':'sine', 'Square':'square', 'Triange':'triangle', 'Sawtooth':'sawtooth'} ).onChange(menuTestOscWave);
	TestOscFolder.add( config, 'TestOscFreq', 30, 8000 ).step(config.TestOscFreq/1.414 ).name('TestOsc Freq Hz:').onChange(menuTestFreq);
	TestOscFolder.add( config, 'TestOscVol', 0, 100).name('TestOsc Volume:').onChange(menuTestFreq);
		 
	console.log('gui:', gui);
	gui.close(); 
	
	}  // ! SetupGUI	
		
  
//***********************************************************************************************************


// MIDI CONFIG
let midiOutput = null;
let currentSequenceId = -1;
const START = 41;
let intervals = [0, 4, 7, 11, 12, 11, 7, 4];
let sequence =  intervals.map(x => x + START);
const NOTE_ON = 0x90;
const NOTE_OFF = 0x80;
const NOTE_DURATION = 300;

connect();

//***********************************************************************************************************

function midiSend(c,mn,v,dur)  {
	if(typeof dur == 'undefined') dur = 1000; 
	c = Math.floor(c);
	mn = Math.floor(mn);
	v = Math.floor(v);
	let n = MIDIkeys(threshold.key,mn); // check note - correct into current key	
	if(c>255) c=NOTE_OFF;
	if(n>127) {n=n-67; if(n>127) n=32;}
	if(v>127) v=0x7F;
	if(dur>2000) dur=2000;
	if(n<0) n=30;
	if(v<0) v=30;
	
	midiOutput.send([c,n,v] ); 
 	console.log("midi Note OUT send:",c,n,v,3*dur); 	
     metric0.textContent = c;		
	 metricm2.textContent = n;		
	 metricm3.textContent = v;		
	
	if(c>=0x90&&c<=0x9F) {  //  144 NOTE_ON
		midiOutput.send( [(c-0x90+0x80),n,0], window.performance.now() + 3*dur ); // Inlined array creation- note off 
//		console.log("midi Note-Off send:",(c-0x90+0x80),n,0,Math.floor(  3*dur)); 	
		}
	}

function UpdateAPC20_MIDI() {     // sends note-off's to btns to initialize
    let vel = 127;
    if(config.RUN_FLAG) { 
           midiOutput.send([NOTE_ON + 0, 50, 127]); 
           midiOutput.send([NOTE_ON + 2, 50, 0x7F]); } 
    else { midiOutput.send([NOTE_OFF + 0, 50, 0]);
           midiOutput.send([NOTE_OFF + 2, 50, 0]);  }
    if(config.OSC_DEMO_FLAG) { 
           midiOutput.send([NOTE_ON + 1, 50, 127]); 
           midiOutput.send([NOTE_ON + 3, 50, 0x7F]); } 
    else { midiOutput.send([NOTE_OFF + 1, 50, 0]); 
           midiOutput.send([NOTE_OFF + 3, 50, 0]); } 
    
    if(config.DemoSequence_Flag) {   // btn 7
           midiOutput.send([NOTE_ON + 7, 50, 127]); } 
    else { midiOutput.send([NOTE_OFF + 7, 50, 0]); }
    if(config.LFO_PHASE_Flag) {   // btn 8
           midiOutput.send([NOTE_ON + 7, 50, 127]); } 
    else { midiOutput.send([NOTE_OFF + 7, 50, 0]); }

   // if(config.LFO_EN) { 
    if(config.LFO_CY2_flag) { 
           midiOutput.send([NOTE_ON + 0, 49, 127]); } 
    else { midiOutput.send([NOTE_OFF + 0, 49, 0]); }
    if(config.LFO_Colorthrob) { 
           midiOutput.send([NOTE_ON + 1, 49, 127]); } 
    else { midiOutput.send([NOTE_OFF + 1, 49, 0]); }
    if(config.LFO_mvel) { 
           midiOutput.send([NOTE_ON + 2, 49, 127]); } 
    else { midiOutput.send([NOTE_OFF + 2, 49, 0]); }
    if(config.LFO_oscVel) { 
           midiOutput.send([NOTE_ON + 3, 49, 127]); } 
    else { midiOutput.send([NOTE_OFF + 3, 49, 0]); }
    if(config.LFO_oscDiam) { 
           midiOutput.send([NOTE_ON + 4, 49, 127]); } 
    else { midiOutput.send([NOTE_OFF + 4, 49, 0]); }
    if(config.LFO_CX1_flag) { 
           midiOutput.send([NOTE_ON + 5, 49, 127]); } 
    else { midiOutput.send([NOTE_OFF + 5, 49, 0]); }
    if(config.LFO_CX2_flag) { 
           midiOutput.send([NOTE_ON + 6, 49, 127]); } 
    else { midiOutput.send([NOTE_OFF + 6, 49, 0]); }
    if(config.LFO_CY1_flag) { 
           midiOutput.send([NOTE_ON + 7, 49, 127]); } 
    else { midiOutput.send([NOTE_OFF + 7, 49, 0]); }
  
}  // !UpdateAPC20_MIDI()


function InitAPC20_MIDI() {    
    for (let i=0;i<8;i++)   {       // sends note-off's to btns to initialize
        midiOutput.send([NOTE_OFF + i, 48, 0x00]);
        console.log ('MIDI Output:' , NOTE_OFF + i, 48, 0x00);
        midiOutput.send([NOTE_OFF + i, 49, 0x00]);
        midiOutput.send([NOTE_OFF + i, 50, 0x00]);
        }  // /for
        UpdateAPC20_MIDI();
}  // !InitAPC20_MIDI()

  const playSeq = function() {
  if (currentSequenceId >= 0) {
    midiOutput.send([NOTE_OFF, sequence[currentSequenceId], 0x7f]);
  }
  currentSequenceId++;
  if (currentSequenceId >= sequence.length) {
    currentSequenceId = 0;
  }
  midiOutput.send([NOTE_ON, sequence[currentSequenceId], 0x7f]);
  console.log ('MIDI Output:' , NOTE_ON, sequence[currentSequenceId], 0x7f);
  setTimeout(playSeq, NOTE_DURATION);
}    // !PlaySeq


function connect() {
  navigator.requestMIDIAccess()
  .then(
    (midi) => midiReady(midi),
    (err) => console.log('Something went wrong - NO MIDI', err));
    }   // ! connect()

function midiReady(midi) {
    
  // Also react to device changes.
  midi.addEventListener('statechange', (event) => initDevices(event.target));
  initDevices(midi); // see the next section!
 // console.log('MIDI InitDevices complete. ');
 
    // MIDI devices that you send data to.
    const outputs = midi.outputs.values();
    console.log('List ALL MIDI Output Ports:', outputs);
    for(const output of outputs) {
      if(output.id=='output-3') { 
		console.log('MIDI Out port:' , output);
        midiOutput = output;
        }
	}	
    //playSeq();
    midiANO() ;  /// InitAPC20_MIDI();
    };  // ! midiReady

 
 
 //  outputs.send([0x90, 0x3C, 0x80]);  // hexadecimal
 // outputs.send([144, 60, 128]);      // decimal
 

function initDevices(midi) {
  // Reset.
  for (var input of midi.inputs.values()) {
        input.onmidimessage = midiMessageReceived;
    }
 
  // MIDI devices that send you data.
  const inputs = midi.inputs.values();
//  console.log('inputs:' , inputs);

  for (let input = inputs.next(); input && !input.done; input = inputs.next()) {
  //  midiIn.push(input.value);
    console.log('input.value:' , input.value);
    }
  
}  // ! initDevices

function midiMessageReceived(event) {
  // MIDI commands we care about. 
  // console.log(event);    // print raw packet
  
  const NOTE_ON = 9;
  const NOTE_OFF = 8;
  const AFTERTOUCH = 10;    // A = Aftertouch
  const CC = 11;            // B = Continuous Control Change (2)
  const PGM_CHANGE = 12;    // C = PGM Change (2)
  const PRESSURE = 13;      // D = PRESSURE (1)
  const PITCH_BEND = 14;    // E = PITCH BEND (2)
 
  const ch = (event.data[0] & 15)+1;
  const cmd = event.data[0] >> 4;
  const pitch = event.data[1];
  const velocity = (event.data.length > 2) ? event.data[2] : 1;
  // You can use the timestamp to figure out the duration of each note.
  const timestamp = Date.now();
  let Note = 0; 
  
  if (cmd === NOTE_OFF || (cmd === NOTE_ON && velocity === 0)) {
    console.log('NoteOff:',cmd,pitch,velocity );
 
   if (pitch == 50)  { // apc20 Actuator Btns Row
        if(ch===1) { config.RUN_FLAG=false;    }
        if(ch===2) { config.OSC_DEMO_FLAG=false; }
        if(ch===3) {Note = ('K');}
        if(ch===4) {Note = ('-');}
        if(ch===5) {Note = ('6');}
        if(ch===6) {Note = ('1');}
        if(ch===7) { config.DemoSequence_Flag = false; }
        if(ch===8) { LFO_PHASE = -1; config.LFO_PHASE_Flag = false; }
        }
    if (pitch == 49)  { // apc20 SOLO/CUE Btns Row - BLUE
     //   if(ch===1) { config.LFO_EN = false; }
        if(ch===2) { config.LFO_Colorthrob = false; }
        if(ch===3) { config.LFO_mvel = false; }
        if(ch===4) { config.LFO_oscVel = false; }
        if(ch===5) { config.LFO_oscDiam = false; }
        if(ch===6) { config.LFO_CX1_flag = false; }
        if(ch===7) { config.LFO_CY1_flag = false;}
        if(ch===8) { config.LFO_CX2_flag = false; }
        if(ch===1) { config.LFO_CY2_flag = false; }
   
        }
   if (pitch == 48)  { // apc20 Record Btns Row - RED
        if(ch===1) { AltFlag[0] = false; }
        if(ch===2) { AltFlag[1] = false; }
        if(ch===3) { AltFlag[2] = false; }
        if(ch===4) { AltFlag[3] = false; }
        if(ch===5) { AltFlag[4] = false; }
        if(ch===6) { AltFlag[5] = false; }
        if(ch===7) { AltFlag[6] = false; }
        if(ch===8) { AltFlag[7] = false; }       
        }
        UpdateAPC20_MIDI;
 
         gui.updateDisplay();
    }    // /NoteOff

   else if (cmd === NOTE_ON) {
    console.log('NoteOff:',cmd,pitch,velocity );
    let Note = 0;
      
      if (pitch == 50)  { // apc20 Actuator Btns Row
        if(ch===1) {config.RUN_FLAG=true;       midiOutput.send([NOTE_ON + 2, 50, 0x7F]); }
        //if(ch===2) {config.OSC_DEMO_FLAG=true;  midiOutput.send([NOTE_ON + 3, 50, 0x7F]); }
        if(ch===3) {Note = ('K');}
        if(ch===4) {Note = ('-');}
        if(ch===5) {Note = ('6');}
        if(ch===6) {Note = ('1');}
        if(ch===7) { config.DemoSequence_Flag = true; }
        if(ch===8) { LFO_PHASE = 1; config.LFO_PHASE_Flag = true; }
                   
        }
    if (pitch == 49)  { // apc20 SOLO/CUE Btns Row
       // if(ch===1) {config.LFO_EN = true;}
        if(ch===2) {config.LFO_Colorthrob = true;}
        if(ch===3) {config.LFO_mvel = true;}
        if(ch===4) { config.LFO_oscVel = true; }
        if(ch===5) { config.LFO_oscDiam = true; }
        if(ch===6) { config.LFO_CX1_flag = true; }
        if(ch===7) { config.LFO_CY1_flag = true;}
        if(ch===8) { config.LFO_CX2_flag = true; }
        if(ch===1) { config.LFO_CY2_flag = true; }
   
        }
    if (pitch == 48)  { // apc20 Record Btns Row
        if(ch===1) { AltFlag[0] = true; }
        if(ch===2) { AltFlag[1] = true; }
        if(ch===3) { AltFlag[2] = true; }
        if(ch===4) { AltFlag[3] = true; }
        if(ch===5) { AltFlag[4] = true; }
        if(ch===6) { AltFlag[5] = true; }
        if(ch===7) { AltFlag[6] = true; }
        if(ch===8) { AltFlag[7] = true; }
                   
        }

     if (pitch == 53)  { // apc20 1ST ROW
        if(ch===1) {Note = ('t');}
        if(ch===2) {Note = ('q');}
        if(ch===3) {Note = ('a');}
        if(ch===4) {Note = ('g');}
        if(ch===5) {Note = ('1');}
        if(ch===6) {Note = ('6');}
        if(ch===7) {Note = ('1');}
        if(ch===8) {Note = ('6');}
                   
        }
     if (pitch == 54) { // apc20 2nd ROW
        if(ch===1) {Note = ('y');}
        if(ch===2) {Note = ('w');}
        if(ch===3) {Note = ('s');}
        if(ch===4) {Note = ('h');}
        if(ch===5) {Note = ('2');}
        if(ch===6) {Note = ('7');}
        if(ch===7) {Note = ('2');}
        if(ch===8) {Note = ('7');}
                   
        }
     if (pitch == 55)  { // apc20 3rd ROW
        if(ch===1) {Note = ('u');}
        if(ch===2) {Note = ('e');}
        if(ch===3) {Note = ('d');}
        if(ch===4) {Note = ('j');}
        if(ch===5) {Note = ('3');}
        if(ch===6) {Note = ('8');}
        if(ch===7) {Note = ('3');}
        if(ch===8) {Note = ('8');}
                   
        }
     if (pitch == 56) { // apc20 4th ROW
        if(ch===1) {Note = ('i');}
        if(ch===2) {Note = ('r');}
        if(ch===3) {Note = ('f');}
        if(ch===4) {Note = ('k');}
        if(ch===5) {Note = ('4');}
        if(ch===6) {Note = ('9');}
        if(ch===7) {Note = ('4');}
        if(ch===8) {Note = ('9');}
                   
        }
     if (pitch == 57)  { // apc20 5th ROW
        if(ch===1) {KeyHandler('t');KeyHandler('i');}
        if(ch===2) {KeyHandler('q');KeyHandler('r');}
        if(ch===3) {KeyHandler('a');KeyHandler('f');}
        if(ch===4) {KeyHandler('g');KeyHandler('k');}
        if(ch===5) {Note = ('5');}
        if(ch===6) {Note = ('0');}
        if(ch===7) {Note = ('5');}
        if(ch===8) {Note = ('0');}
                   
        }
     if (pitch == 52) { // apc20 CLIP-STOP ROW
        if(ch===1) {KeyHandler('y');KeyHandler('u');}
        if(ch===2) {KeyHandler('w');KeyHandler('e');}
        if(ch===3) {KeyHandler('s');KeyHandler('d');}
        if(ch===4) {Note = ('4');  }  
        if(ch===5) {Note = ('7');  }
        if(ch===6) {Note = ('3');}
        if(ch===7) {Note = ('2');}
        if(ch===8) {Note = ('3');}
                   
        }

    if (pitch == 81)  { location.reload() ; }    // SHIFT BTN --- RESET
    if (pitch == 82)  { Note = ('Y');   }        // press Y - black backcolor 
    if (pitch == 83)  { Note = ('R');   }        // press R - random backcolor
    if (pitch == 84)  { canvas.requestFullscreen(); }        
    if (pitch == 85)  { if(gui.closed) { gui.open(); gui.show(); } else { gui.close(); gui.hide(); }  }       
    if (pitch == 86)  { config.PAUSED=!config.PAUSED;   }        // press  F G H
   

    if (ch === 1 && velocity === 127)   { // MIDIMIX CONTROLLER - MUTE Row
        if(pitch==1) { config.RUN_FLAG=!config.RUN_FLAG;    }
      //  if(pitch==4) { config.OSC_DEMO_FLAG=!config.OSC_DEMO_FLAG; }
        if(pitch==7) {Note = ('K');}
        if(pitch==10) {Note = ('-');}
        if(pitch===13) { config.DemoSequence_Flag = !config.DemoSequence_Flag; }
        if(pitch===16) { config.LFO_Colorthrob = !config.LFO_Colorthrob;}
        if(pitch===19) { Note = ('R')  }  // random color
        if(pitch===22) { Note = ('Y')  }  // black color
        
        gui.updateDisplay();
        }
    if (ch === 1 && velocity === 127)  { // // MIDIMIX CONTROLLER - REC ARM Row
        if(pitch===3) { config.LFO_CX1_flag = !config.LFO_CX1_flag; }
        if(pitch===6) { config.LFO_CY1_flag = !config.LFO_CY1_flag;}
        if(pitch===9) { config.LFO_CX2_flag = !config.LFO_CX2_flag; }
        if(pitch===12) { config.LFO_CY2_flag = !config.LFO_CY2_flag; }
        if(pitch===15) { config.LFO_mvel = !config.LFO_mvel; }
        if(pitch===18) { config.LFO_oscVel = !config.LFO_oscVel; }
        if(pitch===21) { config.LFO_oscDiam = !config.LFO_oscDiam; }
        if(pitch===24) { config.LFO_Colorthrob = !config.LFO_Colorthrob; }
       
        if(pitch===27) { // Solo - map to REVERSE
            LFO_PHASE = -1; 
            config.LFO_PHASE_Flag = !config.LFO_PHASE_Flag;
            if(config.LFO_PHASE_Flag) { LFO_PHASE = 1;  }     
            }
        if(pitch==26) { if(gui.closed) { gui.open(); gui.show(); } else { gui.close(); gui.hide(); }  }  // BANK RIGHT - ASSIGNED TO SETTINGS
        if(pitch==25) { location.reload() ; }       // BANK LEFT --- RESET
        gui.updateDisplay();
        }


      //  case 36 // 24h -  assign to    
    
      if (pitch == 36)
      Note = ('1');    // press  1
      if (pitch == 37)
      Note = ('2');    // press  2
      if (pitch == 38)
      Note = ('3');    // press  3
      if (pitch == 39)
      Note = ('4');    // press  4
      if (pitch == 40)
      Note = ('5');    // press  5
      if (pitch == 41)
      Note = ('6');    // press 6
      if (pitch == 42)
      Note = ('7');    // press 7
      if (pitch == 43)
      Note = ('8');    // press 8
      if (pitch == 44)
      Note = ('9');    // press 9
      if (pitch == 45)
      Note = ('0');    // press 

      if (pitch == 46)
     
      if (pitch == 47)
      Note = ('p');    // press p 
     


      if (pitch == 58)
      Note = ('d');    // press d
      if (pitch == 59)
      Note = ('f');    // press f

      if (pitch == 60)                                   // C5
      Note = ('g');    // press g
      if (pitch == 61)
      Note = ('h');    // press h
      if (pitch == 62)
      Note = ('j');    // press j
      if (pitch == 63)
      Note = ('k');    // press k

      if (pitch == 64)
      Note = ('l');    // press l  - 
      if (pitch == 65)
      Note = (';');    // press ;
      if (pitch == 66)
      Note = ('.');    // press .
      if (pitch == 67)
      Note = ('/');    // press /

      if (pitch == 68)
      Note = ('p');    // press   
      
      if (pitch == 69)
      Note = ('c');    // press  
      if (pitch == 70)
      Note = ('v');    // press  
      if (pitch == 71)
      Note = ('b');    // press   
      if (pitch == 72)                                   
      Note = ('n');    // press   

      if (pitch == 73)
      Note = ('[');    // config.BLOOM = FALSE; ALSO TOGGLES LFO_PHASE_Flag
      if (pitch == 74)
      Note = (']');    // config.BLOOM = TRUE 
      
     if (pitch == 75)
      Note =']';// config.BLOOM = true; 
     if (pitch == 76)
      Note='['; // config.BLOOM = FALSE; ALSO TOGGLES LFO_PHASE_Flag
     
      if (pitch == 77)
      Note = ('Q');    // press Q
      if (pitch == 78)
      Note = ('W');    // press W
      if (pitch == 79)
      Note = ('E');    // press E
      if (pitch == 80)
      Note = ('R');    // press R  - bkgnd COLOR RANDOM
      


      if (pitch == 86)
        Note = ('O');    // press O - BPM
      if (pitch == 87)
        Note = ('L');    // press L
      if (pitch == 88)
        Note = ('P');    // press P - SPEED
      if (pitch == 89)
        Note = (':');    // press :
      if (pitch == 90)
        Note = (' ');    // press ' 'pause 

      if (config.MIDI_oscDiam) { config.OSC_DIAMETER = velocity; }  // data for handler
      if (config.MIDI_oscVel) { config.oscVel = velocity; }  // data for handler
      if (config.MIDI_mvel)   { config.mvel = velocity;   }  // data for handler
      KeyHandler(Note) ;        // send keypress
      gui.updateDisplay();
      UpdateAPC20_MIDI;
      console.log("Note ON Ch", ch, "MIDI NOTE:",pitch, 'Vel:' ,velocity );
 
   }   // ! note ON

   else if (cmd === CC) {
    if (pitch === 12)   {
        pointers[0].moved = true;                       // touchpad "X"
        let tempx = canvas.width*velocity/128 ;
        pointers[0].dx = (tempx - pointers[0].x) * 5.0;
        pointers[0].x = tempx;
        }

    if (pitch === 13)   {
        pointers[0].moved = true;                       // touchpad "Y"
        let tempy = canvas.height*(128-velocity)/128 ;
        pointers[0].dy = (tempy - pointers[0].y) * 5.0;
        pointers[0].y = tempy;
        }
    
    if (pitch === 47)   {           // APC20 CUE Knob INC/DEC = map to BPM
        if(ch===1)
        if(velocity>125)  {
            KeyHandler('L');            
            }
        else if (velocity <2) {
            KeyHandler('O');
            }
        gui.updateDisplay();
        }
    if (pitch === 14)   {            // APC20 MASTER Fader ch 1 = map to OSC SPEED  cnt
       config.speed=velocity/2;   
       console.log("MASTER Fader: Ch", ch, "OSC CNT SIZE:", speed);
       gui.updateDisplay();
        }

    if (pitch === 7)   {            // APC20 Fader ch 1-8 = map to 
        if(ch===1)  {
            if(!AltFlag[0]) {
                config.sdt = 0.001 + velocity/60;   // .001 - 2.90           
                console.log("Fader1:", " Step Time", config.sdt); 
            }
            else  {
                config.LFO_BPM = 0.5+velocity*120/128;   // .5 -120    
                resetLFO();       
                console.log("Fader1:", " LFO BPM", config.LFO_BPM); 
            }
        }   
        if(ch===2)  {
            if(!AltFlag[1]) {
            config.VELOCITY_DISSIPATION = 0.8 + velocity/630;   
            console.log("Fader2:", "Velocity", config.VELOCITY_DISSIPATION); 
        }
            else  {
                config.LFO_AMPLC = 1+velocity;   // 1-128           
                console.log("Fader2:", " LFO AMPLC COLOR", config.LFO_AMPLC); 
            }
        }   
        if(ch===3)  {
            if(!AltFlag[2]) {
           config.DENSITY_DISSIPATION = 0.8 + velocity/630;   
            console.log("Fader3:", "Density", config.DENSITY_DISSIPATION);  
        }
            else  {
                config.LFO_AMPL2 = 1+velocity;   // 1-128           
                console.log("Fader3:", " LFO AMPL2 mVel", config.LFO_AMPL2); 
            }
        }   
        if(ch===4)  {
            if(!AltFlag[3]) {
            config.PRESSURE_DISSIPATION = velocity/126;   
            console.log("Fader4:", "Pressure", config.PRESSURE_DISSIPATION);  
        }
            else  {
                config.LFO_AMPL3 = 1+velocity;   // 1-128           
                console.log("Fader4:", " LFO AMPL3 oscVel", config.LFO_AMPL3); 
            }
        }   
        if(ch===5)  {
            if(!AltFlag[4]) {
            config.CURL = velocity*10/127;   
            console.log("Fader5:", "Curl", config.CURL);  
        }
            else  {
                config.OSC_RADIUS = 0.01+velocity*1/128;   //.1 5.0     
                console.log("Fader5:", " OSC RADIUS", config.OSC_RADIUS); 
            }
        }   
        if(ch===6)  {
            if(!AltFlag[5]) {
           config.SPLAT_RADIUS = 0.01+velocity*1/128;   //.1 5.0
            console.log("Fader6:", "Splat Size", config.SPLAT_RADIUS);  
        }
            else  {
                config.OSC_DIAMETER = velocity;   // 1-128    
                if(!config.LFO_oscDiam) OSC_DIA_min = config.OSC_DIAMETER;       
                console.log("Fader6:", " OSC DIAMETER", config.OSC_DIAMETER); 
            }
        }   
        if(ch===7)  {
            if(!AltFlag[6]) {
           config.mvel = velocity;   
           OSC_mvel_min = config.mvel;  
            console.log("Fader7:", "MIDI Velocity", config.mvel);  
        }
            else  {
                config.DELTASIZE = 1+velocity;   // 1-128           
                console.log("Fader7:", " OSC SIZE", config.DELTASIZE); 
            }
        }   
        if(ch===8)  {
            if(!AltFlag[7]) {
            config.DELTAMULT = 0.5+velocity;   
            console.log("Fader8:", " OSC MULT", config.DELTAMULT);  
        }
            else  {
                config.oscVel = 1+velocity;   // 1-128       
                OSC_oscVel_min = config.oscVel;    
                console.log("Fader8:", " oscVel", config.oscVel); 
            }
        }   
        gui.updateDisplay();
        }  // ! Faders

    if (pitch === 16)   {           // APC20 PLAY BTNS ch 1-9 = map to 
        if(ch===1)  { console.log("PLAY:");  
            //KeyHandler('K');
            //KeyHandler('L'); 
            //KeyHandler('-'); 
            //KeyHandler('='); 
            config.RUN_FLAG=true; 
            config.OSC_DEMO_FLAG=true;
           
            }
        else if(ch===2)  { console.log("STOP:");  
            config.RUN_FLAG=false; 
            config.OSC_DEMO_FLAG=false;
            config.BKColorChangeFLAG=false;
 
            config.LFO_EN=false;
            config.LFO_Colorthrob=false;
            config.LFO_mvel=false;
 
            LFO_PHASE= -1;       // -1 or 1 --- changes spin direction
            config.LFO_PHASE_Flag = false;
           // config.RUN_FLAG=!config.RUN_FLAG; 
           // config.OSC_DEMO_FLAG=!config.OSC_DEMO_FLAG;
           
            }
        else {
             config.OSC_DEMO=7+ch;  
            }    
    
        gui.updateDisplay();
        console.log("PLAY BTNS Ch", ch );
        }  // ! pitch===16

    if (ch === 1)  {    // MIDIMIX  ch 1
        // TOP ROW KNOBS
        if (pitch === 16)   {   // MIDIMIX TOP row 1 = map to 
            config.sdt = 0.001 + velocity/60;   // .001 - 2.90           
            console.log("KNOB-TOP-1:", " Step Time", config.sdt); 
            }
        if (pitch === 20)   {   // MIDIMIX TOP row 2 = map to 
            config.VELOCITY_DISSIPATION = 0.8 + velocity/630;   
            console.log("KNOB-TOP-2:", "Velocity", config.VELOCITY_DISSIPATION); 
            }
        if (pitch === 24)   {   // MIDIMIX TOP row 3 = map to 
            config.DENSITY_DISSIPATION = 0.8 + velocity/630;   
            console.log("KNOB-TOP-3:", "Density", config.DENSITY_DISSIPATION);  
            }
        if (pitch === 28)   {   // MIDIMIX TOP row 4 = map to 
            config.PRESSURE_DISSIPATION = velocity/126;   
            console.log("KNOB-TOP-4:", "Pressure", config.PRESSURE_DISSIPATION);  
            }

        if (pitch === 46)   {   // MIDIMIX TOP row 5 = map to 
            config.CURL = velocity*10/127;   
            console.log("KNOB-TOP-5:", "Curl", config.CURL);  
            }
        if (pitch === 50)   {   // MIDIMIX TOP row 6 = map to 
            config.SPLAT_RADIUS = 0.01+velocity*1/128;   //.1 5.0
            console.log("KNOB-TOP-6:", "Splat Size", config.SPLAT_RADIUS);  
            }
        if (pitch === 54)   {   // MIDIMIX TOP row 7 = map to   
            config.mvel = velocity;   
            OSC_mvel_min = config.mvel;  
            console.log("KNOB-MID-7:", " mVel ", config.mvel); 
            }
        if (pitch === 58)   {   // MIDIMIX TOP row 8= map to 
            config.OSC_RADIUS = 0.01+velocity*1/128;   //.1 5.0  
            console.log("KNOB-MID-8:", " Osc size ", config.OSC_RADIUS); 
           
            }

    // MID ROW KNOBS
        if (pitch === 17)   {   // MIDIMIX MID row 1 = map to 
            CX1offset = -(64-velocity)*config.DELTAMULT/3;   // CENTER X1          
            console.log("KNOB-MID-1:", " CX1 offset", CX1offset); 
            }
        if (pitch === 21)   {   // MIDIMIX MID row 2 = map to 
            CY1offset = -(64-velocity)*config.DELTAMULT/3;   // CENTER Y1          
            console.log("KNOB-MID-2:", " CY1 offset", CY1offset); 
            }
        if (pitch === 25)   {   // MIDIMIX MID row 3 = map to      
            CX2offset = -(64-velocity)*config.DELTAMULT/3 ;   // CENTER X2          
            console.log("KNOB-MID-3:", " CX2 offset", CX2offset); 
            }
        if (pitch === 29)   {   // MIDIMIX MID row 4 = map to 
            CY2offset = -(64-velocity)*config.DELTAMULT/3;   // CENTER X2          
            console.log("KNOB-MID-4:", " CY2 offset", CY2offset); 
            }
          
        if (pitch === 47)   {   // MIDIMIX MID row 5 = map to 
            config.mvel = velocity; 
            OSC_mvel_min = config.mvel;    
            console.log("KNOB-MID-5:", " mVel ", config.mvel); 
            }
        if (pitch === 51)   {   // MIDIMIX MID row 6 = map to 
            config.oscVel = velocity;   
            OSC_oscVel_min = config.oscVel;  
            console.log("KNOB-MID-6:", " oscVel ", config.oscVel); 
             } 
       
        if (pitch === 55)   {   // MIDIMIX MID row 7 = map to 
            config.DELTASIZE = 1+velocity;   // 1-128           
            console.log("Fader7:", " OSC SIZE", config.DELTASIZE); 
            }
        if (pitch === 59)   {   // MIDIMIX MID row 8= map to 
            config.DELTAMULT = 0.5+velocity;   
            console.log("Fader8:", " OSC MULT", config.DELTAMULT);  
            }

 // BOT ROW KNOBS
        if (pitch === 18)   {   // MIDIMIX BOT row 1 = map to R
            config.BACK_COLOR.r =2*velocity;   // 0-254         
            console.log("KNOB-BOT-1", " BG R ", config.BACK_COLOR.r); 
            }
        if (pitch === 22)   {   // MIDIMIX BOT row 2 = map to G
            config.BACK_COLOR.g = 2*velocity;   // 0-254         
            console.log("KNOB-BOT-2:", "BG G ", config.BACK_COLOR.g);  
            }
        if (pitch === 26)   {   // MIDIMIX BOT row 3 = map to B
            config.BACK_COLOR.b = 2*velocity;   // 0-254         
            console.log("KNOB-BOT-3:", "BG B ", config.BACK_COLOR.b);  
            }
        if (pitch === 30)   {   // MIDIMIX BOT row 4 = map to LFO COLOR FACTOR
            config.LFO_AMPLC = 1+velocity;   // 1-128           
            console.log("KNOB-BOT-4:", " LFO AMPLC COLOR", config.LFO_AMPLC); 
            }

        if (pitch === 48)   {   // MIDIMIX BOT row 5 = map to 
            config.LFO_AMPL1 = 1+velocity;   // 1-128           
            console.log("KNOB-BOT-5:", " LFO AMPL1 mVel", config.LFO_AMPL1); 
            }
        if (pitch === 52)   {   // MIDIMIX BOT row 6 = map to 
            config.LFO_AMPL2 = 1+velocity;   // 1-128           
            console.log("KNOB-BOT-6:", " LFO AMPL2 oscVel", config.LFO_AMPL2); 
            }
        if (pitch === 56)   {   // MIDIMIX BOT row 7 = map to      
            config.LFO_AMPL3 = 1+velocity;   // 1-128           
            console.log("KNOB-BOT-7", " LFO AMPL3 oscDia", config.LFO_AMPL3); 
            }
        if (pitch === 60)   {   // MIDIMIX BOT row 8 = map to 
            config.LFO_AMPL4 = 1+velocity;   // 1-128           
            console.log("KNOB-BOT-8", " LFO AMPL4 oscSize", config.LFO_AMPL4); 
            }


            // FADERS
        if (pitch === 19)   {   // MIDIMIX FADER 1 = map to 
            config.LFO_BPM = 0.5+velocity*120/128;   // .5 -120    
            resetLFO();       
            console.log("Fader1:", " LFO BPM", config.LFO_BPM); 
            }    
        if (pitch === 23)   {   // MIDIMIX FADER 2 = map to 
            config.SPLAT_RADIUS = 0.01+velocity*1/128;   //.1 5.0
            console.log("Fader2:", "Splat Size", config.SPLAT_RADIUS);  
            }   
        if (pitch === 27)   {   // MIDIMIX FADER 3 = map to 
            config.mvel = velocity;   
            OSC_mvel_min = config.mvel;  
            console.log("Fader3:", " mVel ", config.mvel); 
            }
        if (pitch === 31)   {   // MIDIMIX FADER 4 = map to 
            config.speed=velocity/2;   
            console.log("Fader4:", " Speed/Size", config.speed); 
            }

        if (pitch === 49)   {   // MIDIMIX FADER 5 = map to 
            config.OSC_RADIUS = 0.01+velocity*1/128;   //.1 5.0     
            console.log("Fader5:", " OSC RADIUS", config.OSC_RADIUS); 
            }
        if (pitch === 53)   {   // MIDIMIX FADER 6 = map to 
            config.OSC_DIAMETER = velocity;   // 1-128    
            if(!config.LFO_oscDiam) OSC_DIA_min = config.OSC_DIAMETER;       
            console.log("Fader6:", " OSC DIAMETER", config.OSC_DIAMETER); 
            }
        if (pitch === 57)   {   // MIDIMIX FADER 7 = map to 
            config.DELTASIZE = 1+velocity;   // 1-128           
            console.log("Fader7:", " OSC SIZE", config.DELTASIZE); 
            }
        if (pitch === 61)   {   // MIDIMIX FADER 8 = map to 
            config.DELTAMULT = 0.5+velocity;   
            console.log("Fader8:", " OSC MULT", config.DELTAMULT);  
            }

        if (pitch === 62)   {   // MIDIMIX MASTER FADER = map to 
            config.TIME = 20+velocity*256/128;   // 20 -286    
            resetInterval();       
            console.log("MASTERFader:", " BPM", config.TIME); 
            }
    gui.updateDisplay();
      
    }  // ! MIDIMIX  ch 1

  // console.log("Ch", ch,cmd , "CC:", pitch , "VAL:", velocity);
   
  }  // !CC
  else {
    console.log("Ch", ch,cmd , "NUM:", pitch , "VAL:", velocity);
    //console.log(event);  // show raw midi
  }
}   // ! midiMessage received event

function sendMidiMessage(pitch, velocity, duration) {
  const NOTE_ON = 0x90;
  const NOTE_OFF = 0x80;
  
  const device = midiOut[selectOut.selectedIndex];
  const msgOn = [NOTE_ON, pitch, velocity];
  const msgOff = [NOTE_OFF, pitch, velocity];
  
  // First send the note on;
  device.send(msgOn); 
    
  // Then send the note off. You can send this separately if you want 
  // (i.e. when the button is released)
  device.send(msgOff, Date.now() + duration); 
}   // !SendMIDImessage


//***************************************************************

 </script>
	</body>
</html>
